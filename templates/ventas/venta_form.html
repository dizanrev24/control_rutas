{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Nueva Venta - Sistema de Gestión{% endblock %}

{% block extra_css %}
<style>
    .formset-row {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    .formset-row:last-child {
        border-bottom: none;
    }
    .subtotal-display {
        font-weight: bold;
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-cart-plus me-2"></i>Nueva Venta
        </h1>
        <a href="{% url 'dentro_visita' detalle_planificacion.id %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver a Visita
        </a>
    </div>

    <form method="post" id="ventaForm">
        {% csrf_token %}
        {% if formset.non_form_errors %}
        <div class="alert alert-danger">
            <strong>Errores en los productos:</strong>
            <ul class="mb-0">
                {% for e in formset.non_form_errors %}
                    <li>{{ e }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        <div class="row g-3">
            <div class="col-12 col-lg-8">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="mb-0">Productos en el camión</h5>
                        </div>
                        <div class="ms-3" style="min-width: 260px;">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="buscador" placeholder="Buscar producto...">
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div id="lista-productos" class="row row-cols-1 row-cols-md-2 g-2">
                            {% for det in productos_cargados %}
                                <div class="col producto-item" data-nombre="{{ det.producto.nombre|lower }}" data-id="{{ det.producto.id }}" data-precio="{{ det.producto.precio_venta }}" data-stock="{{ det.cantidad_actual|floatformat:0 }}">
                                    <div class="border rounded p-2 h-100 d-flex flex-column justify-content-between">
                                        <div>
                                            <div class="fw-semibold">{{ det.producto.nombre }}</div>
                                            <div class="small text-muted">Stock: {{ det.cantidad_actual|floatformat:0 }} | Precio: Q{{ det.producto.precio_venta }}</div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2 mt-2">
                                            <input type="number" class="form-control form-control-sm input-cant" min="1" step="1" value="1" style="max-width: 100px;">
                                            <button type="button" class="btn btn-sm btn-primary btn-add-prod"><i class="bi bi-plus-circle me-1"></i>Agregar</button>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="col-12"><div class="alert alert-warning mb-0">No hay productos cargados en el camión para hoy.</div></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="alert alert-light border">
                    <i class="bi bi-info-circle me-2"></i>
                    Agrega productos desde el listado. Puedes ajustar cantidades y precios después en el carrito.
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Carrito</h5>
                    </div>
                    <div class="card-body">
                        <div id="cart-items" class="vstack gap-2"></div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-semibold">Total</div>
                            <div class="fs-4 text-success" id="total-venta">Q0.00</div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Información adicional</h6>
                    </div>
                    <div class="card-body">
                        {% crispy venta_form %}
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <a href="{% url 'dentro_visita' detalle_planificacion.id %}" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle me-1"></i>Confirmar Venta
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mb-3 d-none">
            <div class="card-header">
                <h5 class="mb-0">Productos</h5>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                <div id="formset-container">
                    {% for form in formset %}
                        <div class="formset-row" data-form-index="{{ forloop.counter0 }}">
                            <div class="row align-items-end g-3">
                                <div class="col-12 col-md-5">
                                    {{ form.producto|as_crispy_field }}
                                </div>
                                <div class="col-6 col-md-2">
                                    {{ form.cantidad|as_crispy_field }}
                                </div>
                                <div class="col-6 col-md-2">
                                    {{ form.precio_unitario|as_crispy_field }}
                                </div>
                                <div class="col-6 col-md-2">
                                    <label class="form-label">Subtotal</label>
                                    <div class="form-control-plaintext subtotal-display" id="subtotal-{{ forloop.counter0 }}">
                                        Q 0.00
                                    </div>
                                </div>
                                <div class="col-6 col-md-1 text-end">
                                    {{ form.DELETE }}
                                    <button type="button" class="btn btn-outline-danger btn-sm btn-remove" data-index="{{ forloop.counter0 }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-muted">No hay productos agregados aún. Usa el botón "Agregar producto".</div>
                    {% endfor %}
                </div>

                <!-- Template oculto para nuevas filas -->
                <template id="empty-form-template">
                    <div class="formset-row" data-form-index="__prefix__">
                        <div class="row align-items-end g-3">
                            <div class="col-12 col-md-5">
                                {{ formset.empty_form.producto|as_crispy_field }}
                            </div>
                            <div class="col-6 col-md-2">
                                {{ formset.empty_form.cantidad|as_crispy_field }}
                            </div>
                            <div class="col-6 col-md-2">
                                {{ formset.empty_form.precio_unitario|as_crispy_field }}
                            </div>
                            <div class="col-6 col-md-2">
                                <label class="form-label">Subtotal</label>
                                <div class="form-control-plaintext subtotal-display" id="subtotal-__prefix__">Q 0.00</div>
                            </div>
                            <div class="col-6 col-md-1 text-end">
                                {{ formset.empty_form.DELETE }}
                                <button type="button" class="btn btn-outline-danger btn-sm btn-remove" data-index="__prefix__">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="mt-3">
                    <button type="button" id="btn-add" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle me-1"></i>Agregar producto
                    </button>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Información Adicional</h5>
            </div>
            <div class="card-body">
                {% crispy venta_form %}
            </div>
        </div>

    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function marcarFilasVaciasParaEliminar() {
            const total = parseInt(document.querySelector('[name="detalles-TOTAL_FORMS"]').value || '0', 10);
            for (let i = 0; i < total; i++) {
                const prod = document.querySelector(`[name="detalles-${i}-producto"]`);
                const cant = document.querySelector(`[name="detalles-${i}-cantidad"]`);
                const precio = document.querySelector(`[name="detalles-${i}-precio_unitario"]`);
                const del = document.querySelector(`[name="detalles-${i}-DELETE"]`);
                if (!prod || !cant || !precio) continue;
                const prodVal = (prod.value || '').toString().trim();
                const cantVal = parseInt(cant.value || '0', 10) || 0;
                const precioVal = parseFloat(precio.value || '0') || 0;
                if (!prodVal || cantVal <= 0 || precioVal <= 0) {
                    if (del) del.checked = true;
                    const row = document.querySelector(`.formset-row[data-form-index="${i}"]`);
                    if (row) row.style.display = 'none';
                }
            }
        }
        // Función para calcular subtotal de una línea
        function calcularSubtotal(index) {
            const cantidadInput = document.querySelector(`[name="detalles-${index}-cantidad"]`);
            const precioInput = document.querySelector(`[name="detalles-${index}-precio_unitario"]`);
            const subtotalDisplay = document.getElementById(`subtotal-${index}`);
            
            if (cantidadInput && precioInput && subtotalDisplay) {
                const cantidad = parseInt(cantidadInput.value || '0', 10) || 0;
                const precio = parseFloat(precioInput.value) || 0;
                const subtotal = cantidad * precio;
                
                subtotalDisplay.textContent = `Q${subtotal.toFixed(2)}`;
            }
        }
        
        // Función para calcular total de la venta
        function calcularTotal() {
            let total = 0;
            
            document.querySelectorAll('.subtotal-display').forEach(function(element) {
                const valor = parseFloat(element.textContent.replace('Q', '')) || 0;
                total += valor;
            });
            
            document.getElementById('total-venta').textContent = `Q${total.toFixed(2)}`;
        }
        
        function attachRowEvents(index) {
            const inputs = document.querySelectorAll(`[name="detalles-${index}-cantidad"], [name="detalles-${index}-precio_unitario"]`);
            inputs.forEach(function(input){
                input.addEventListener('input', function(){
                    calcularSubtotal(index);
                    calcularTotal();
                });
            });

            const btnRemove = document.querySelector(`.btn-remove[data-index="${index}"]`);
            if (btnRemove) {
                btnRemove.addEventListener('click', function(){
                    const row = document.querySelector(`.formset-row[data-form-index="${index}"]`);
                    const delInput = document.querySelector(`[name="detalles-${index}-DELETE"]`);
                    if (delInput) {
                        delInput.checked = true;
                    }
                    if (row) row.style.display = 'none';
                    calcularTotal();
                });
            }
        }

        // Buscador
        const buscador = document.getElementById('buscador');
        if (buscador) {
            buscador.addEventListener('input', function(){
                const q = this.value.trim().toLowerCase();
                document.querySelectorAll('#lista-productos .producto-item').forEach(function(card){
                    const nombre = card.getAttribute('data-nombre');
                    card.style.display = nombre.includes(q) ? '' : 'none';
                });
            });
        }

        // Añadir desde cards de productos
        document.querySelectorAll('.btn-add-prod').forEach(function(btn){
            btn.addEventListener('click', function(){
                const card = this.closest('.producto-item');
                const prodId = card.getAttribute('data-id');
                const precio = parseFloat(card.getAttribute('data-precio')) || 0;
                const stock = parseInt((card.getAttribute('data-stock') || '0'), 10) || 0;
                const inputCant = card.querySelector('.input-cant');
                let cant = parseInt(inputCant.value || '1', 10) || 1;
                cant = Math.max(1, cant);
                if (cant > stock) {
                    Swal.fire({icon:'warning',title:'Stock insuficiente',text:`Solo hay ${stock} disponibles.`});
                    return;
                }

                const totalInput = document.querySelector('[name="detalles-TOTAL_FORMS"]');
                let index = parseInt(totalInput.value);
                const template = document.getElementById('empty-form-template').content.cloneNode(true);
                let html = template.firstElementChild.outerHTML.replace(/__prefix__/g, index);
                const wrapper = document.createElement('div');
                wrapper.innerHTML = html;
                const row = wrapper.firstElementChild;
                document.getElementById('formset-container').appendChild(row);

                // Setear valores
                const selectProd = row.querySelector(`[name="detalles-${index}-producto"]`);
                const inputCantRow = row.querySelector(`[name="detalles-${index}-cantidad"]`);
                const inputPrecio = row.querySelector(`[name="detalles-${index}-precio_unitario"]`);
                if (selectProd) {
                    selectProd.value = prodId;
                }
                if (inputCantRow) inputCantRow.value = cant;
                if (inputPrecio) inputPrecio.value = precio.toFixed(2);

                totalInput.value = index + 1;
                attachRowEvents(index);
                calcularSubtotal(index);
                calcularTotal();

                // Agregar al carrito visual
                const nombre = card.querySelector('.fw-semibold').textContent.trim();
                const cartItem = document.createElement('div');
                cartItem.className = 'd-flex justify-content-between align-items-center border rounded p-2';
                cartItem.setAttribute('data-index', index);
                cartItem.innerHTML = `
                    <div class="me-2 small">
                        <div class="fw-semibold">${nombre}</div>
                        <div class="text-muted">${cant} x Q${precio.toFixed(2)}</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove-cart"><i class="bi bi-x"></i></button>
                `;
                document.getElementById('cart-items').appendChild(cartItem);

                // Al eliminar desde carrito
                cartItem.querySelector('.btn-remove-cart').addEventListener('click', function(){
                    const i = cartItem.getAttribute('data-index');
                    const delInput = document.querySelector(`[name="detalles-${i}-DELETE"]`);
                    const fsRow = document.querySelector(`.formset-row[data-form-index="${i}"]`);
                    if (delInput) delInput.checked = true;
                    if (fsRow) fsRow.style.display = 'none';
                    cartItem.remove();
                    calcularTotal();
                });
            });
        });

        // Adjuntar eventos a filas existentes
        const totalFormsets = parseInt(document.querySelector('[name="detalles-TOTAL_FORMS"]').value);
        for (let i = 0; i < totalFormsets; i++) {
            attachRowEvents(i);
            calcularSubtotal(i);
        }
        
        calcularTotal();

        // Agregar nueva fila
        document.getElementById('btn-add').addEventListener('click', function(){
            const totalInput = document.querySelector('[name="detalles-TOTAL_FORMS"]');
            let index = parseInt(totalInput.value);
            const template = document.getElementById('empty-form-template').content.cloneNode(true);
            const html = template.firstElementChild.outerHTML.replace(/__prefix__/g, index);

            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            document.getElementById('formset-container').appendChild(wrapper.firstElementChild);

            totalInput.value = index + 1;
            attachRowEvents(index);
        });
        
        // Validar antes de enviar
        document.getElementById('ventaForm').addEventListener('submit', function(e) {
            // Marcar filas vacías o inválidas como DELETE para evitar errores requeridos
            marcarFilasVaciasParaEliminar();
            const total = parseFloat(document.getElementById('total-venta').textContent.replace('Q', '')) || 0;
            
            if (total <= 0) {
                e.preventDefault();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Debes agregar al menos un producto con cantidad y precio válidos.',
                    confirmButtonColor: '#d33'
                });
                return false;
            }
            
            // Confirmación final
            e.preventDefault();
            Swal.fire({
                title: '¿Confirmar Venta?',
                html: `<p>Total: <strong>Q${total.toFixed(2)}</strong></p><p>Se descontará el stock del camión.</p>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    e.target.submit();
                }
            });
        });
    });
</script>
{% endblock %}
